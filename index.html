<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Assistant IA Contrat â€“ SCORE</title>
<style>
  :root{
    --teal:#00a6a6; --ink:#0f172a; --bg:#f7fafc; --card:#fff; --muted:#64748b; --ok:#16a34a; --err:#dc2626;
  }
  body{margin:0;font-family:Inter,Roboto,system-ui,-apple-system,Segoe UI,Arial;}
  /* Bouton flottant pour ouvrir/fermer */
  .fab{position:fixed;right:16px;bottom:16px;background:var(--teal);color:#fff;border:none;border-radius:999px;padding:12px 16px;box-shadow:0 8px 20px rgba(0,0,0,.2);cursor:pointer;z-index:9998}
  /* Panneau latÃ©ral */
  #assistant{
    position:fixed;inset:0 0 0 auto;width:400px;max-width:92vw;background:var(--bg);
    border-left:3px solid var(--teal);box-shadow:-8px 0 24px rgba(0,0,0,.15);
    display:flex;flex-direction:column;z-index:9999;transform:translateX(0);transition:.25s ease;
  }
  #assistant.hidden{transform:translateX(110%)}
  header{display:flex;align-items:center;gap:8px;padding:12px 14px;background:var(--teal);color:#fff}
  header h3{margin:0;font-weight:600}
  header .close{margin-left:auto;background:transparent;border:none;color:#fff;cursor:pointer;font-size:18px}
  main{padding:14px;display:flex;flex-direction:column;gap:10px;overflow:auto}
  .hint{color:var(--muted);font-size:12px}
  textarea,input{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:10px;font-size:14px;background:#fff}
  .row{display:grid;grid-template-columns:1fr;gap:8px}
  .label{font-size:12px;color:#334155;font-weight:600;display:flex;align-items:center;gap:6px}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{border:1px solid #cbd5e1;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .chip.active{background:var(--teal);border-color:var(--teal);color:#fff}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .btn{background:var(--teal);color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--teal);border:1px solid var(--teal)}
  .small{font-size:12px}
  .valid{font-size:12px;color:var(--ok)}
  .invalid{font-size:12px;color:var(--err)}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  pre{margin:0;white-space:pre-wrap;word-break:break-word;font-size:12px;line-height:1.4}
</style>
</head>
<body>

<button class="fab" id="toggleFab">ğŸ¤– Assistant contrat</button>

<aside id="assistant" class="hidden" aria-label="Assistant IA Contrat">
  <header>
    <span>ğŸ¤–</span><h3>Assistant contrat</h3>
    <button class="close" id="closeBtn" title="Fermer">âœ•</button>
  </header>

  <main>
    <!-- 1) Commande naturelle + parsing -->
    <section class="row">
      <div class="label">ğŸ—£ï¸ Commande en langage naturel</div>
      <textarea id="nl" rows="3" placeholder="Ex. Je souhaite crÃ©er un contrat de type PBH sur le moteur LEAP-1A avec lâ€™identifiant ContratÃ¨que CFM-2025-ABCDE pour le client Air France, rÃ©fÃ©rence du contrat 3-7420."></textarea>
      <div class="grid-2">
        <button class="btn" id="btnParse">Analyser & prÃ©-remplir</button>
        <button class="btn ghost" id="btnTemplate">ğŸ² Remplir un exemple</button>
      </div>
      <div class="hint">Astuce : colle une phrase, clique Â« Analyser Â», puis ajuste via les chips ci-dessous.</div>
    </section>

    <!-- 2) SÃ©lections guidÃ©es (mode clic) -->
    <section class="row">
      <div class="label">ğŸ§­ Type de contrat</div>
      <div id="chipsType" class="chips"></div>
    </section>

    <section class="row">
      <div class="label">ğŸ› ï¸ Moteur</div>
      <div id="chipsMoteur" class="chips"></div>
    </section>

    <section class="row">
      <div class="label">ğŸ‘¤ Client</div>
      <input id="client" placeholder="Ex. Air France"/>
      <div class="chips" id="chipsClient"></div>
    </section>

    <!-- 3) Identifiants + validation live -->
    <section class="grid-2">
      <div>
        <div class="label">ğŸ“‡ Identifiant ContratÃ¨que</div>
        <input id="idContrateque" placeholder="CFM-2025-ABCDE"/>
        <div id="idStatus" class="small"></div>
      </div>
      <div>
        <div class="label">ğŸ”– RÃ©fÃ©rence contrat</div>
        <input id="refContrat" placeholder="3-7420"/>
        <div id="refStatus" class="small"></div>
      </div>
    </section>
    <div class="grid-2">
      <button class="btn ghost" id="btnGenId">Auto-gÃ©nÃ©rer CFM-2025-xxxxx</button>
      <button class="btn ghost" id="btnGenRef">Auto-gÃ©nÃ©rer Z-ZZZZ</button>
    </div>

    <!-- 4) AperÃ§u & export -->
    <section class="card">
      <div class="label">ğŸ‘ï¸â€ğŸ—¨ï¸ AperÃ§u</div>
      <pre id="preview">â€”</pre>
      <div class="grid-2" style="margin-top:8px">
        <button class="btn" id="btnCreate">âœ… CrÃ©er le contrat</button>
        <button class="btn ghost" id="btnCopyJson">ğŸ“‹ Copier JSON</button>
      </div>
    </section>
  </main>
</aside>

<script>
/* ---------------- Config suggestions ---------------- */
const TYPES = ["PBH","Time & Material","Full Support","On Condition","Exchange","Inspection"];
const MOTEURS = ["LEAP-1A","LEAP-1B","CFM56-5B","CFM56-7B","CFM56-3","CF6-80E1"];
const CLIENTS = ["Air France","Transavia France","easyJet","Ryanair","KLM","Lufthansa","Safran Test Fleet"];
/* ---------------- Helpers UI ---------------- */
const qs = s=>document.querySelector(s);
const el = {
  panel: qs("#assistant"),
  fab: qs("#toggleFab"),
  close: qs("#closeBtn"),
  nl: qs("#nl"),
  chipsType: qs("#chipsType"),
  chipsMoteur: qs("#chipsMoteur"),
  chipsClient: qs("#chipsClient"),
  client: qs("#client"),
  id: qs("#idContrateque"),
  ref: qs("#refContrat"),
  idStatus: qs("#idStatus"),
  refStatus: qs("#refStatus"),
  preview: qs("#preview"),
  btnParse: qs("#btnParse"),
  btnTemplate: qs("#btnTemplate"),
  btnGenId: qs("#btnGenId"),
  btnGenRef: qs("#btnGenRef"),
  btnCreate: qs("#btnCreate"),
  btnCopyJson: qs("#btnCopyJson"),
};
/* ---------------- State ---------------- */
const state = { type:"", moteur:"", client:"", id:"", ref:"" };
/* ---------------- Chips builders ---------------- */
function buildChips(container, values, onPick){
  container.innerHTML="";
  values.forEach(v=>{
    const c=document.createElement("button");
    c.type="button"; c.className="chip"; c.textContent=v;
    c.onclick=()=>{ onPick(v); refresh(); };
    container.appendChild(c);
  });
}
buildChips(el.chipsType, TYPES, v=>state.type=v);
buildChips(el.chipsMoteur, MOTEURS, v=>state.moteur=v);
buildChips(el.chipsClient, CLIENTS, v=>{ state.client=v; el.client.value=v; });

/* ---------------- Parsing NL ---------------- */
function parseNL(text){
  const t=text;
  const pickFromList=(list)=>list.find(x=>new RegExp("\\b"+x.replace(/[-/]/g,"[-/]") +"\\b","i").test(t))||"";
  const type = pickFromList(TYPES);
  const moteur = pickFromList(MOTEURS);
  const clientMatch = CLIENTS.find(c=>new RegExp("\\b"+c.replace(" ","\\s")+"\\b","i").test(t));
  const client = clientMatch || (t.match(/client\s+([A-Za-z][\w\s\-']{1,40})/i)?.[1]?.trim() || "");
  const id = (t.match(/CFM[-â€“]\s?2025[-â€“]\s?[A-Z0-9]{5}/i)?.[0] || "").replace(/\s/g,"").replace(/â€“/g,"-").toUpperCase();
  const ref = (t.match(/\b([0-9])[-â€“]([0-9]{4})\b/)?.[0] || "").replace(/â€“/g,"-");
  return {type,moteur,client,id,ref};
}
/* ---------------- Generators ---------------- */
function genCFM(){ return "CFM-2025-"+Array.from({length:5},()=> "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[Math.floor(Math.random()*32)]).join(""); }
function genRef(){
  const z = Math.floor(Math.random()*9)+1; // 1..9
  const n = String(Math.floor(Math.random()*10000)).padStart(4,"0");
  return `${z}-${n}`;
}
/* ---------------- Validators ---------------- */
function validateId(v){ return /^CFM-2025-[A-Z0-9]{5}$/.test(v); }
function validateRef(v){ return /^[1-9]-\d{4}$/.test(v); }
/* ---------------- Render ---------------- */
function refresh(){
  // sync inputs -> state when manual typing
  state.client = el.client.value || state.client;
  state.id = el.id.value || state.id;
  state.ref = el.ref.value || state.ref;

  // highlight active chips
  document.querySelectorAll("#chipsType .chip").forEach(ch=>ch.classList.toggle("active", ch.textContent===state.type));
  document.querySelectorAll("#chipsMoteur .chip").forEach(ch=>ch.classList.toggle("active", ch.textContent===state.moteur));
  document.querySelectorAll("#chipsClient .chip").forEach(ch=>ch.classList.toggle("active", ch.textContent===state.client));

  // live validation
  const idOk = validateId(state.id);
  const refOk = validateRef(state.ref);
  el.idStatus.textContent = state.id ? (idOk?"âœ“ Format OK (CFM-2025-ABCDE)":"âœ— Format attendu : CFM-2025-XXXXX") : "";
  el.idStatus.className = state.id ? (idOk?"valid":"invalid") : "small";
  el.refStatus.textContent = state.ref ? (refOk?"âœ“ Format OK (Z-ZZZZ)":"âœ— Format attendu : Z-ZZZZ (Z=chiffre 1â€“9)") : "";
  el.refStatus.className = state.ref ? (refOk?"valid":"invalid") : "small";

  // preview
  const payload = {
    date: new Date().toISOString().slice(0,10),
    client: state.client || null,
    contractType: state.type || null,
    engine: state.moteur || null,
    contratequeId: state.id || null,
    contractRef: state.ref || null,
    source: "assistant-ia-sidepanel",
  };
  el.preview.textContent = JSON.stringify(payload,null,2);
}
/* ---------------- Wire events ---------------- */
el.fab.onclick=()=>el.panel.classList.toggle("hidden");
el.close.onclick=()=>el.panel.classList.add("hidden");

el.btnTemplate.onclick=()=>{
  el.nl.value = "Je souhaite crÃ©er un contrat de type PBH sur le moteur LEAP-1A avec lâ€™identifiant ContratÃ¨que CFM-2025-ABCDE pour le client Air France, rÃ©fÃ©rence du contrat 3-7420.";
};
el.btnParse.onclick=()=>{
  const r = parseNL(el.nl.value);
  if(r.type) state.type=r.type;
  if(r.moteur) state.moteur=r.moteur;
  if(r.client) { state.client=r.client; el.client.value=r.client; }
  if(r.id) { state.id=r.id; el.id.value=r.id; }
  if(r.ref) { state.ref=r.ref; el.ref.value=r.ref; }
  refresh();
};

el.client.oninput=()=>{ state.client=el.client.value; refresh(); };
el.id.oninput=()=>{ state.id=el.id.value.toUpperCase().replace(/â€“/g,"-"); refresh(); };
el.ref.oninput=()=>{ state.ref=el.ref.value.replace(/â€“/g,"-"); refresh(); };

el.btnGenId.onclick=()=>{ const v=genCFM(); state.id=v; el.id.value=v; refresh(); };
el.btnGenRef.onclick=()=>{ const v=genRef(); state.ref=v; el.ref.value=v; refresh(); };

el.btnCopyJson.onclick=async()=>{
  try{
    await navigator.clipboard.writeText(el.preview.textContent);
    el.btnCopyJson.textContent="âœ… CopiÃ© !";
    setTimeout(()=>el.btnCopyJson.textContent="ğŸ“‹ Copier JSON",1200);
  }catch(e){ alert("Copie impossible : "+e.message); }
};

el.btnCreate.onclick=()=>{
  const idOk=validateId(state.id), refOk=validateRef(state.ref);
  const missing = [];
  if(!state.type) missing.push("type de contrat");
  if(!state.moteur) missing.push("moteur");
  if(!state.client) missing.push("client");
  if(!idOk) missing.push("identifiant ContratÃ¨que (CFM-2025-XXXXX)");
  if(!refOk) missing.push("rÃ©fÃ©rence (Z-ZZZZ)");
  if(missing.length){
    alert("Veuillez complÃ©ter/valider :\nâ€¢ " + missing.join("\nâ€¢ "));
    return;
  }
  // âœ Ici, appelle ton backend / Firestore / API SCORE
  console.log("CREATE_CONTRACT", JSON.parse(el.preview.textContent));
  alert("âœ… Contrat crÃ©Ã© (simulation). Voir console.");
};

refresh(); // first render
</script>
</body>
</html>
