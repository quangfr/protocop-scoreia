<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assistant IA Contrat ‚Äì SCORE</title>
  <style>
    :root {
      --teal: #00a6a6;
      --ink: #0f172a;
      --bg: #f7fafc;
      --card: #fff;
      --muted: #64748b;
      --ok: #16a34a;
      --err: #dc2626;
    }

    body {
      margin: 0;
      font-family: Inter, Roboto, system-ui, -apple-system, Segoe UI, Arial;
    }

    .assistant-panel {
      position: fixed;
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 30px 60px rgba(15, 23, 42, .35);
      display: flex;
      flex-direction: column;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease, transform .3s ease;
      z-index: 9999;
    }

    .assistant-panel.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #chatPanel {
      left: 50%;
      bottom: 72px;
      width: min(360px, calc(100vw - 32px));
    }

    #chatPanel:not(.visible) {
      transform: translate(-50%, 24px);
    }

    #chatPanel.visible {
      transform: translate(-50%, 0);
    }

    #commandPanel {
      right: 16px;
      top: 16px;
      bottom: 16px;
      width: min(420px, calc(100vw - 32px));
      height: calc(100vh - 32px);
    }

    #commandPanel:not(.visible) {
      transform: translateY(24px);
    }

    #commandPanel.visible {
      transform: translateY(0);
    }

    #natural-command {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
    }

    .assistant-trigger {
      position: fixed;
      bottom: 16px;
      padding: 12px 20px;
      border-radius: 999px;
      border: none;
      background: var(--teal);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0, 0, 0, .25);
      z-index: 9998;
    }

    .assistant-trigger-center {
      left: 50%;
      transform: translateX(-50%);
    }

    .assistant-trigger-right {
      right: 16px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      background: var(--teal);
      color: #fff;
      border-radius: 12px;
    }

    header h3 {
      margin: 0;
      font-weight: 600;
    }

    header .close {
      margin-left: auto;
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 18px;
    }

    .hint {
      color: var(--muted);
      font-size: 12px
    }

    textarea,
    input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px;
      font-size: 14px;
      background: #fff
    }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px
    }

    .label {
      font-size: 12px;
      color: #334155;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .chatcard {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .chatbox {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #fff;
      min-height: 160px;
      max-height: 220px;
      overflow: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .msg {
      display: flex;
      gap: 8px
    }

    .msg.assistant {
      justify-content: flex-start
    }

    .msg.user {
      justify-content: flex-end
    }

    .bubble {
      max-width: 80%;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08)
    }

    .msg.assistant .bubble {
      background: rgba(0, 166, 166, 0.12);
      color: var(--ink);
      border-top-left-radius: 4px
    }

    .msg.user .bubble {
      background: var(--teal);
      color: #fff;
      border-top-right-radius: 4px
    }

    .chat-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .chat-actions .btn {
      flex: 1 1 auto
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px
    }

    .chip {
      border: 1px solid #cbd5e1;
      background: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer
    }

    .chip.active {
      background: var(--teal);
      border-color: var(--teal);
      color: #fff
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px
    }

    .btn {
      background: var(--teal);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer
    }

    .btn.ghost {
      background: #fff;
      color: var(--teal);
      border: 1px solid var(--teal)
    }

    .small {
      font-size: 12px
    }

    .valid {
      font-size: 12px;
      color: var(--ok)
    }

    .invalid {
      font-size: 12px;
      color: var(--err)
    }

    .card {
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      line-height: 1.4
    }
  </style>
  </head>

  <body>

    <button class="assistant-trigger assistant-trigger-center" id="openChatAssistant" aria-label="Ouvrir la conversation">
      Assistant Contrat
    </button>
    <button class="assistant-trigger assistant-trigger-right" id="openCommandAssistant"
      aria-label="Ouvrir la commande naturelle">
      Assistant Contrat
    </button>

    <aside id="chatPanel" class="assistant-panel" aria-label="Conversation guid√©e">
      <header>
        <span>ü§ñ</span>
        <h3>Assistant contrat</h3>
        <button class="close" id="closeChat" title="Fermer">‚úï</button>
      </header>
      <section class="card chatcard">
        <div class="label">üí¨ Conversation guid√©e</div>
        <div id="chat" class="chatbox" aria-live="polite"></div>
        <div class="chat-actions">
          <input id="chatInput" placeholder="Tape ta r√©ponse et appuie sur Entr√©e" autocomplete="off" />
          <button class="btn" id="chatSend">Envoyer</button>
          <button class="btn ghost" id="chatStart">üîÅ Recommencer</button>
        </div>
        <div class="hint">Utilise la conversation pour te laisser guider pas √† pas. Tu peux r√©pondre ¬´ auto ¬ª pour
          g√©n√©rer automatiquement les identifiants.</div>
      </section>
    </aside>

    <aside id="commandPanel" class="assistant-panel" aria-label="Commande naturelle">
      <header>
        <span>üß≠</span>
        <h3>Assistant commande</h3>
        <button class="close" id="closeCommand" title="Fermer">‚úï</button>
      </header>
      <div id="natural-command">
        <section class="row ">
          <div class="label">üó£Ô∏è Commande en langage naturel</div>
          <textarea id="nl" rows="3"
            placeholder="Ex. Je souhaite cr√©er un contrat de type PBH sur le moteur LEAP-1A avec l‚Äôidentifiant Contrat√®que CFM-2025-ABCDE pour le client Air France, r√©f√©rence du contrat 3-7420."></textarea>
          <div class="grid-2">
            <button class="btn" id="btnParse">Analyser & pr√©-remplir</button>
            <button class="btn ghost" id="btnTemplate">üé≤ Remplir un exemple</button>
          </div>
          <div class="hint">Astuce : colle une phrase, clique ¬´ Analyser ¬ª, puis ajuste via les chips ci-dessous.</div>
        </section>

        <section class="row">
          <div class="label">üß≠ Type de contrat</div>
          <div id="chipsType" class="chips"></div>
        </section>

        <section class="row">
          <div class="label">üõ†Ô∏è Moteur</div>
          <div id="chipsMoteur" class="chips"></div>
        </section>

        <section class="row">
          <div class="label">üë§ Client</div>
          <input id="client" placeholder="Ex. Air France" />
          <div class="chips" id="chipsClient"></div>
        </section>

        <section class="grid-2">
          <div>
            <div class="label">üìá Identifiant Contrat√®que</div>
            <input id="idContrateque" placeholder="CFM-2025-ABCDE" />
            <div id="idStatus" class="small"></div>
          </div>
          <div>
            <div class="label">üîñ R√©f√©rence contrat</div>
            <input id="refContrat" placeholder="3-7420" />
            <div id="refStatus" class="small"></div>
          </div>
        </section>
        <div class="grid-2">
          <button class="btn ghost" id="btnGenId">Auto-g√©n√©rer CFM-2025-xxxxx</button>
          <button class="btn ghost" id="btnGenRef">Auto-g√©n√©rer Z-ZZZZ</button>
        </div>

        <section class="card">
          <div class="label">üëÅÔ∏è‚Äçüó®Ô∏è Aper√ßu</div>
          <pre id="preview">‚Äî</pre>
          <div class="grid-2" style="margin-top:8px">
            <button class="btn" id="btnCreate">‚úÖ Cr√©er le contrat</button>
            <button class="btn ghost" id="btnCopyJson">üìã Copier JSON</button>
          </div>
        </section>
      </div>
    </aside>

    <script>
    /* ---------------- Config suggestions ---------------- */
    const TYPES = ["PBH", "Time & Material", "Full Support", "On Condition", "Exchange", "Inspection"];
    const MOTEURS = ["LEAP-1A", "LEAP-1B", "CFM56-5B", "CFM56-7B", "CFM56-3", "CF6-80E1"];
    const CLIENTS = ["Air France", "Transavia France", "easyJet", "Ryanair", "KLM", "Lufthansa", "Safran Test Fleet"];
    /* ---------------- Helpers UI ---------------- */
    const qs = s => document.querySelector(s);
    const el = {
      chatPanel: qs("#chatPanel"),
      commandPanel: qs("#commandPanel"),
      openChat: qs("#openChatAssistant"),
      openCommand: qs("#openCommandAssistant"),
      closeChat: qs("#closeChat"),
      closeCommand: qs("#closeCommand"),
      chat: qs("#chat"),
      chatInput: qs("#chatInput"),
      chatSend: qs("#chatSend"),
      chatStart: qs("#chatStart"),
      nl: qs("#nl"),
      chipsType: qs("#chipsType"),
      chipsMoteur: qs("#chipsMoteur"),
      chipsClient: qs("#chipsClient"),
      client: qs("#client"),
      id: qs("#idContrateque"),
      ref: qs("#refContrat"),
      idStatus: qs("#idStatus"),
      refStatus: qs("#refStatus"),
      preview: qs("#preview"),
      btnParse: qs("#btnParse"),
      btnTemplate: qs("#btnTemplate"),
      btnGenId: qs("#btnGenId"),
      btnGenRef: qs("#btnGenRef"),
      btnCreate: qs("#btnCreate"),
      btnCopyJson: qs("#btnCopyJson"),
    };
    /* ---------------- State ---------------- */
    const state = { type: "", moteur: "", client: "", id: "", ref: "" };
    const convo = { active: false, stepIndex: -1 };
    /* ---------------- Chips builders ---------------- */
    function buildChips(container, values, onPick) {
      container.innerHTML = "";
      values.forEach(v => {
        const c = document.createElement("button");
        c.type = "button"; c.className = "chip"; c.textContent = v;
        c.onclick = () => { onPick(v); refresh(); };
        container.appendChild(c);
      });
    }
    buildChips(el.chipsType, TYPES, v => state.type = v);
    buildChips(el.chipsMoteur, MOTEURS, v => state.moteur = v);
    buildChips(el.chipsClient, CLIENTS, v => { state.client = v; el.client.value = v; });

    /* ---------------- Parsing NL ---------------- */
    function parseNL(text) {
      const t = text;
      const pickFromList = (list) => list.find(x => new RegExp("\\b" + x.replace(/[-/]/g, "[-/]") + "\\b", "i").test(t)) || "";
      const type = pickFromList(TYPES);
      const moteur = pickFromList(MOTEURS);
      const clientMatch = CLIENTS.find(c => new RegExp("\\b" + c.replace(" ", "\\s") + "\\b", "i").test(t));
      const client = clientMatch || (t.match(/client\s+([A-Za-z][\w\s\-']{1,40})/i)?.[1]?.trim() || "");
      const id = (t.match(/CFM[-‚Äì]\s?2025[-‚Äì]\s?[A-Z0-9]{5}/i)?.[0] || "").replace(/\s/g, "").replace(/‚Äì/g, "-").toUpperCase();
      const ref = (t.match(/\b([0-9])[-‚Äì]([0-9]{4})\b/)?.[0] || "").replace(/‚Äì/g, "-");
      return { type, moteur, client, id, ref };
    }
    /* ---------------- Generators ---------------- */
    function genCFM() { return "CFM-2025-" + Array.from({ length: 5 }, () => "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[Math.floor(Math.random() * 32)]).join(""); }
    function genRef() {
      const z = Math.floor(Math.random() * 9) + 1; // 1..9
      const n = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
      return `${z}-${n}`;
    }
    function matchList(answer, list) {
      if (!answer) return "";
      const clean = answer.trim();
      const found = list.find(item => new RegExp(`(^|\b)${item.replace(/[.*+?^${}()|[\]\\]/g, "\\$&").replace(/\s/g, "\\s+")}(\b|$)`, `i`).test(clean));
      return found || "";
    }
    /* ---------------- Validators ---------------- */
    function validateId(v) { return /^CFM-2025-[A-Z0-9]{5}$/.test(v); }
    function validateRef(v) { return /^[1-9]-\d{4}$/.test(v); }
    /* ---------------- Render ---------------- */
    function refresh() {
      // sync inputs -> state when manual typing
      state.client = el.client.value || state.client;
      state.id = el.id.value || state.id;
      state.ref = el.ref.value || state.ref;

      // highlight active chips
      document.querySelectorAll("#chipsType .chip").forEach(ch => ch.classList.toggle("active", ch.textContent === state.type));
      document.querySelectorAll("#chipsMoteur .chip").forEach(ch => ch.classList.toggle("active", ch.textContent === state.moteur));
      document.querySelectorAll("#chipsClient .chip").forEach(ch => ch.classList.toggle("active", ch.textContent === state.client));

      // live validation
      const idOk = validateId(state.id);
      const refOk = validateRef(state.ref);
      el.idStatus.textContent = state.id ? (idOk ? "‚úì Format OK (CFM-2025-ABCDE)" : "‚úó Format attendu : CFM-2025-XXXXX") : "";
      el.idStatus.className = state.id ? (idOk ? "valid" : "invalid") : "small";
      el.refStatus.textContent = state.ref ? (refOk ? "‚úì Format OK (Z-ZZZZ)" : "‚úó Format attendu : Z-ZZZZ (Z=chiffre 1‚Äì9)") : "";
      el.refStatus.className = state.ref ? (refOk ? "valid" : "invalid") : "small";

      // preview
      const payload = {
        date: new Date().toISOString().slice(0, 10),
        client: state.client || null,
        contractType: state.type || null,
        engine: state.moteur || null,
        contratequeId: state.id || null,
        contractRef: state.ref || null,
        source: "assistant-ia-sidepanel",
      };
      el.preview.textContent = JSON.stringify(payload, null, 2);
    }
    function pushMessage(sender, text) {
      const wrapper = document.createElement("div");
      wrapper.className = `msg ${sender}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      wrapper.appendChild(bubble);
      el.chat.appendChild(wrapper);
      el.chat.scrollTop = el.chat.scrollHeight;
    }

    const steps = [
      {
        key: "type",
        question: "Quel est le type de contrat souhait√© ? (PBH, Time & Material, ...)",
        handle(answer) {
          const pick = matchList(answer, TYPES);
          if (!pick) {
            pushMessage("assistant", "Je n‚Äôai pas reconnu le type. Choisis parmi : " + TYPES.join(", ") + ".");
            return false;
          }
          state.type = pick;
          pushMessage("assistant", `Parfait, on part sur ${pick}.`);
          return true;
        }
      },
      {
        key: "moteur",
        question: "Quel moteur est concern√© ? (LEAP-1A, CFM56-7B, ...)",
        handle(answer) {
          const pick = matchList(answer, MOTEURS);
          if (!pick) {
            pushMessage("assistant", "Je n‚Äôai pas reconnu le moteur. Options : " + MOTEURS.join(", ") + ".");
            return false;
          }
          state.moteur = pick;
          pushMessage("assistant", `Compris, moteur ${pick}.`);
          return true;
        }
      },
      {
        key: "client",
        question: "Quel est le client ?",
        handle(answer) {
          const pick = matchList(answer, CLIENTS) || answer.trim();
          if (!pick) {
            pushMessage("assistant", "Peux-tu pr√©ciser le client ?");
            return false;
          }
          state.client = pick;
          el.client.value = pick;
          pushMessage("assistant", `Merci ! Client enregistr√© : ${pick}.`);
          return true;
        }
      },
      {
        key: "id",
        question: "Indique l‚Äôidentifiant Contrat√®que (format CFM-2025-XXXXX) ou r√©ponds ¬´ auto ¬ª.",
        handle(answer) {
          const clean = answer.trim();
          if (/auto/i.test(clean)) {
            const v = genCFM();
            state.id = v;
            el.id.value = v;
            pushMessage("assistant", `C‚Äôest fait, j‚Äôai g√©n√©r√© ${v}.`);
            return true;
          }
          const value = clean.toUpperCase().replace(/‚Äì/g, "-");
          if (!validateId(value)) {
            pushMessage("assistant", "Le format attendu est CFM-2025-XXXXX. Tu peux aussi √©crire ¬´ auto ¬ª.");
            return false;
          }
          state.id = value;
          el.id.value = value;
          pushMessage("assistant", `Identifiant ${value} not√©.`);
          return true;
        }
      },
      {
        key: "ref",
        question: "Quelle est la r√©f√©rence contrat (format Z-ZZZZ) ou r√©ponds ¬´ auto ¬ª ?",
        handle(answer) {
          const clean = answer.trim();
          if (/auto/i.test(clean)) {
            const v = genRef();
            state.ref = v;
            el.ref.value = v;
            pushMessage("assistant", `R√©f√©rence g√©n√©r√©e : ${v}.`);
            return true;
          }
          const value = clean.replace(/‚Äì/g, "-");
          if (!validateRef(value)) {
            pushMessage("assistant", "Merci d‚Äôutiliser le format Z-ZZZZ (ex. 3-7420) ou ¬´ auto ¬ª.");
            return false;
          }
          state.ref = value;
          el.ref.value = value;
          pushMessage("assistant", `R√©f√©rence ${value} enregistr√©e.`);
          return true;
        }
      }
    ];

    function startConversation() {
      convo.active = true;
      convo.stepIndex = 0;
      state.type = "";
      state.moteur = "";
      state.client = "";
      state.id = "";
      state.ref = "";
      el.client.value = "";
      el.id.value = "";
      el.ref.value = "";
      refresh();
      el.chat.innerHTML = "";
      pushMessage("assistant", "Bonjour ! Dis-moi, je vais t‚Äôaider √† cr√©er le contrat en quelques questions.");
      askStep();
    }

    function askStep() {
      if (convo.stepIndex >= steps.length) {
        refresh();
        pushMessage("assistant", "Super, tout est compl√©t√©. Tu peux encore ajuster les champs ou cliquer sur ¬´ Cr√©er le contrat ¬ª.");
        convo.active = false;
        el.chatInput.placeholder = "Conversation termin√©e. Tape une r√©ponse pour relancer.";
        return;
      }
      const current = steps[convo.stepIndex];
      pushMessage("assistant", current.question);
      el.chatInput.placeholder = current.question;
    }

    function handleConversation(answer) {
      if (!convo.active) {
        startConversation();
      }
      const current = steps[convo.stepIndex];
      pushMessage("user", answer);
      if (current.handle(answer)) { // si valide, passer √† l‚Äô√©tape suivante
        convo.stepIndex += 1;
        refresh();
        askStep();
      } else {
        setTimeout(() => askStep(), 200);
      }
    }
    /* ---------------- Wire events ---------------- */
    el.openChat.onclick = () => {
      el.chatPanel.classList.add("visible");
      el.commandPanel.classList.remove("visible");
    };
    el.openCommand.onclick = () => {
      el.commandPanel.classList.add("visible");
      el.chatPanel.classList.remove("visible");
    };
    el.closeChat.onclick = () => el.chatPanel.classList.remove("visible");
    el.closeCommand.onclick = () => el.commandPanel.classList.remove("visible");

    el.chatStart.onclick = () => startConversation();
    el.chatSend.onclick = () => {
      const answer = el.chatInput.value.trim();
      if (!answer) {
        if (!convo.active) startConversation();
        return;
      }
      el.chatInput.value = "";
      handleConversation(answer);
    };
    el.chatInput.addEventListener("keydown", ev => {
      if (ev.key === "Enter") {
        ev.preventDefault();
        el.chatSend.click();
      }
    });

    el.btnTemplate.onclick = () => {
      el.nl.value = "Je souhaite cr√©er un contrat de type PBH sur le moteur LEAP-1A avec l‚Äôidentifiant Contrat√®que CFM-2025-ABCDE pour le client Air France, r√©f√©rence du contrat 3-7420.";
    };
    el.btnParse.onclick = () => {
      const r = parseNL(el.nl.value);
      if (r.type) state.type = r.type;
      if (r.moteur) state.moteur = r.moteur;
      if (r.client) { state.client = r.client; el.client.value = r.client; }
      if (r.id) { state.id = r.id; el.id.value = r.id; }
      if (r.ref) { state.ref = r.ref; el.ref.value = r.ref; }
      refresh();
    };

    el.client.oninput = () => { state.client = el.client.value; refresh(); };
    el.id.oninput = () => { state.id = el.id.value.toUpperCase().replace(/‚Äì/g, "-"); refresh(); };
    el.ref.oninput = () => { state.ref = el.ref.value.replace(/‚Äì/g, "-"); refresh(); };

    el.btnGenId.onclick = () => { const v = genCFM(); state.id = v; el.id.value = v; refresh(); };
    el.btnGenRef.onclick = () => { const v = genRef(); state.ref = v; el.ref.value = v; refresh(); };

    el.btnCopyJson.onclick = async () => {
      try {
        await navigator.clipboard.writeText(el.preview.textContent);
        el.btnCopyJson.textContent = "‚úÖ Copi√© !";
        setTimeout(() => el.btnCopyJson.textContent = "üìã Copier JSON", 1200);
      } catch (e) { alert("Copie impossible : " + e.message); }
    };

    el.btnCreate.onclick = () => {
      const idOk = validateId(state.id), refOk = validateRef(state.ref);
      const missing = [];
      if (!state.type) missing.push("type de contrat");
      if (!state.moteur) missing.push("moteur");
      if (!state.client) missing.push("client");
      if (!idOk) missing.push("identifiant Contrat√®que (CFM-2025-XXXXX)");
      if (!refOk) missing.push("r√©f√©rence (Z-ZZZZ)");
      if (missing.length) {
        alert("Veuillez compl√©ter/valider :\n‚Ä¢ " + missing.join("\n‚Ä¢ "));
        return;
      }
      // ‚ûú Ici, appelle ton backend / Firestore / API SCORE
      console.log("CREATE_CONTRACT", JSON.parse(el.preview.textContent));
      alert("‚úÖ Contrat cr√©√© (simulation). Voir console.");
    };

    refresh(); // first render
    startConversation();
  </script>
</body>

</html>
